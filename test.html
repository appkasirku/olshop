<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=width-device, scale=1.0"/>
<title>Thermal Print 58mm</title>
<style>
  body { font-family: Arial; padding: 20px; }
  button { padding: 10px 15px; margin-bottom: 10px; }
  #status { margin-top: 10px; font-weight: bold; }
</style>
</head>

<body>

<h2>Thermal Printer Bluetooth</h2>

<button onclick="scanBluetooth()">üîç SCAN SERVICES</button>
<p id="uuid">Hasil:</p>

<br>

<button onclick="connectPrinter()">üîó Hubungkan Printer</button>
<br />
<button onclick="printStruk()">üßæ Print Struk</button>

<div id="status">Status: belum terhubung</div>




<!-- ========================================================= -->
<!-- SCAN SEMUA SERVICE DAN CHARACTERISTIC -->
<!-- ========================================================= -->
<script>
async function scanBluetooth() {
    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [
                0xff00, 0xff01, 0xff02, 
                '0000ffe0-0000-1000-8000-00805f9b34fb',
                '0000ffe1-0000-1000-8000-00805f9b34fb',
                '000018f0-0000-1000-8000-00805f9b34fb',
                '00002af1-0000-1000-8000-00805f9b34fb',
                '0000ae30-0000-1000-8000-00805f9b34fb',
                '0000ae01-0000-1000-8000-00805f9b34fb'
            ]
        });

        const server = await device.gatt.connect();
        const services = await server.getPrimaryServices();

        let output = "Hasil:<br>";
        for (const service of services) {
            output += `<br><b>SERVICE:</b> ${service.uuid}<br>`;
            const chars = await service.getCharacteristics();
            for (const c of chars) {
                output += `Characteristic: ${c.uuid}<br>`;
                output += `Properties: ${JSON.stringify(c.properties)}<br><br>`;
            }
        }

        document.getElementById("uuid").innerHTML = output;

    } catch (err) {
        alert("Error: " + err);
    }
}

/*
async function scanBluetooth() {
    try {
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['device_information', 'battery_service', 'generic_access', 'generic_attribute', 0xff00, 0xff01, 0xff02, '0000ffe0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const services = await server.getPrimaryServices();

        let output = "Hasil:<br>";

        for (const service of services) {
            output += `<br><b>SERVICE:</b> ${service.uuid}<br>`;
            const chars = await service.getCharacteristics();

            for (const c of chars) {
                output += `Characteristic: ${c.uuid}<br>`;
                output += `Properties: ${JSON.stringify(c.properties)}<br><br>`;
            }
        }

        document.getElementById("uuid").innerHTML = output;

    } catch (err) {
        alert("Error: " + err);
    }
}
*/
</script>



<!-- ========================================================= -->
<!-- KONEKSI PRINTER (AKAN DIPILIH OTOMATIS SETELAH SCAN) -->
<!-- ========================================================= -->
<script>
let printerDevice = null;
let printerCharacteristic = null;

async function connectPrinter() {
    try {
        printerDevice = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb', 0xff00, 0xff01, 0xff02]
        });

        const server = await printerDevice.gatt.connect();
        const services = await server.getPrimaryServices();

        // >>> Printer thermal BLE PASTI punya characteristic dengan "writeWithoutResponse"
        for (const service of services) {
            const chars = await service.getCharacteristics();
            for (const c of chars) {
                if (c.properties.writeWithoutResponse || c.properties.write) {
                    printerCharacteristic = c; 
                    break;
                }
            }
        }

        if (!printerCharacteristic) {
            return alert("Tidak ditemukan characteristic untuk mengirim data!");
        }

        document.getElementById("status").textContent = 
            "Status: TERHUBUNG ‚úîÔ∏è (" + printerCharacteristic.uuid + ")";

        alert("Printer berhasil terhubung!");
    } catch (err) {
        alert("Gagal terhubung: " + err);
    }
}
</script>



<!-- ========================================================= -->
<!-- PRINT STRUK -->
<!-- ========================================================= -->
<script>
function buatStruk() {
    return (
`TOKO BERAS 20 DESEMBER
Jl. Raya Kemerdekaan No. 21
------------------------------
Produk  : Rojolele Special 5kg
Harga   : Rp 62.500
Qty     : 1
------------------------------
TOTAL   : Rp 62.500
==============================
Terima kasih
Sudah berbelanja

\n\n`
    );
}

function toBytes(text) {
    return new TextEncoder("utf-8").encode(text);
}

async function printStruk() {
    if (!printerCharacteristic) {
        return alert("Printer belum terhubung!");
    }

    let esc_init = new Uint8Array([0x1B, 0x40]); 
    let esc_align_left = new Uint8Array([0x1B, 0x61, 0x00]);

    let text = buatStruk();
    let bytes = toBytes(text);

    try {
        await printerCharacteristic.writeValue(esc_init);
        await printerCharacteristic.writeValue(esc_align_left);
        await printerCharacteristic.writeValue(bytes);

       // alert("Struk berhasil dicetak!");
    } catch (err) {
        alert("Gagal print: " + err);
    }
}
</script>

</body>
</html>